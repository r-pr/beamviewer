(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{22:function(e,t,n){e.exports=n(49)},28:function(e,t,n){},47:function(e,t,n){},48:function(e,t,n){},49:function(e,t,n){"use strict";n.r(t);var o=n(0),s=n.n(o),a=n(19),r=n.n(a),i=n(3),c=n(2),l=n(8),d=n(6),u=n(1),h=n(7),f=(n(28),window.location.host),m="https:"===window.location.protocol?"wss:":"ws:",v={HTTP_SRV_URL:"".concat(window.location.protocol,"//").concat(f),WS_SRV_URL:"".concat(m,"//").concat(f),MAIN_DIV_CLASS:"col-sm-6 col-md-4 col-lg-4 offset-sm-3 offset-md-4 offset-lg-4",DEFAULT_ICE_SERVERS:[{urls:"stun:stun.l.google.com:19302"}]},p=v.MAIN_DIV_CLASS,g=function(e){function t(e,n){var o;return Object(i.a)(this,t),(o=Object(l.a)(this,Object(d.a)(t).call(this,e,n))).onClickPub=o.onClickPub.bind(Object(u.a)(o)),o.onClickSub=o.onClickSub.bind(Object(u.a)(o)),o.onKeyPress=o.onKeyPress.bind(Object(u.a)(o)),o.handleSessIdChange=o.handleSessIdChange.bind(Object(u.a)(o)),o.handleNickNameChnage=o.handleNickNameChnage.bind(Object(u.a)(o)),o.handleAudioCheckboxChange=o.handleAudioCheckboxChange.bind(Object(u.a)(o)),o.state={sessId:"",nickName:"",audioChecked:!1},o}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return s.a.createElement(s.a.Fragment,null,s.a.createElement("div",{className:"row"},s.a.createElement("div",{className:p},s.a.createElement("div",{className:"input-group mb-3"},s.a.createElement("input",{type:"text",className:"form-control",placeholder:"Session ID",value:this.state.sessId,onChange:this.handleSessIdChange,onKeyPress:this.onKeyPress,style:{textAlign:"center"}})),s.a.createElement("button",{className:"btn btn-primary btn-block",onClick:this.onClickSub},"Join session"))),s.a.createElement("div",{className:"row"},s.a.createElement("div",{className:p},s.a.createElement("hr",{style:{margin:"2em 0em"}}),s.a.createElement("div",{className:"form-group"},s.a.createElement("button",{style:{marginBottom:"0.8em"},className:"btn btn-success btn-block",onClick:this.onClickPub},"Create session"),s.a.createElement("div",{className:"form-group form-check"},s.a.createElement("input",{type:"checkbox",className:"form-check-input",id:"checkAudio",onChange:this.handleAudioCheckboxChange,checked:this.state.audioChecked}),s.a.createElement("label",{className:"form-check-label",htmlFor:"checkAudio"},"With audio"))))),s.a.createElement("div",{className:"row",style:{display:this.props.error?"block":"none"}},s.a.createElement("div",{className:p},s.a.createElement("div",{className:"alert alert-danger",role:"alert",style:{marginTop:"1em"}},this.props.error))))}},{key:"handleSessIdChange",value:function(e){this.setState({sessId:e.target.value.trim()})}},{key:"handleNickNameChnage",value:function(e){this.setState({nickName:e.target.value.trim()})}},{key:"handleAudioCheckboxChange",value:function(e){this.setState({audioChecked:e.target.checked})}},{key:"onKeyPress",value:function(e){13===((e=e||window.event).keyCode||e.which)&&this.onClickSub(null)}},{key:"onClickPub",value:function(e){this.props.onDecision({mode:"pub",withAudio:this.state.audioChecked})}},{key:"onClickSub",value:function(e){this.props.onDecision({mode:"sub",nickName:Date.now().toString(),sessionId:this.state.sessId})}}]),t}(s.a.Component),w=n(5),b=n.n(w),k=n(9),y=n(20),C=1,E=function(e){function t(e,n){var o;return Object(i.a)(this,t),(o=Object(l.a)(this,Object(d.a)(t).call(this))).stream=e,o.iceServers=n,o.internalId=void 0,o.rtcConnection=void 0,o.internalId=C,C++,o.rtcConnection=new RTCPeerConnection({iceServers:n}),o.rtcConnection.addStream(e),o.rtcConnection.onicecandidate=function(e){e.candidate&&o.emit("candidate",e.candidate)},o.rtcConnection.oniceconnectionstatechange=function(){"connected"===o.rtcConnection.iceConnectionState?o.emit("connected"):"disconnected"===o.rtcConnection.iceConnectionState&&(o.rtcConnection.close(),o.emit("disconnected"))},o}return Object(h.a)(t,e),Object(c.a)(t,[{key:"getRtcConnection",value:function(){return this.rtcConnection}}]),t}(y.EventEmitter),S=n(21),O=n.n(S);function j(e){return new Promise(function(t){setTimeout(t,e)})}var x=function(){function e(t){Object(i.a)(this,e),this.onCandidate=void 0,this.onOffer=void 0,this.onAnswer=void 0,this.url=void 0,this.ws=void 0,this.pendingPromise=void 0,this.sessId=void 0,this.previousReconnectTime=void 0,this.closedByUser=void 0,this.ws=null,this.url=t,this.pendingPromise={},this.sessId="",this.previousReconnectTime=0,this.closedByUser=!1}return Object(c.a)(e,null,[{key:"getIceServers",value:function(){var e=Object(k.a)(b.a.mark(function e(){var t,n;return b.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t="".concat(v.HTTP_SRV_URL,"/ice_servers"),e.next=3,O.a.get(t);case 3:if(200===(n=e.sent).status&&n.data&&n.data.iceServers){e.next=7;break}return console.warn("default ice servers"),e.abrupt("return",v.DEFAULT_ICE_SERVERS);case 7:return e.abrupt("return",n.data.iceServers);case 8:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}()}]),Object(c.a)(e,[{key:"getSessId",value:function(){return this.sessId}},{key:"connect",value:function(){var e=this;return new Promise(function(t,n){try{console.log("try construct websocket"),e.ws=new WebSocket(e.url),console.log("ws constructed")}catch(o){return console.log("ws construct:: err"),n(o),e.reconnect()}e.ws.onopen=t,e.ws.onerror=function(e,t){console.warn("ws::on_error::",t)},e.ws.onmessage=e.onMessage.bind(e),e.ws.onclose=function(){e.ws.onerror=null,e.ws.onmessage=null,e.closedByUser||(console.log("ws closed, gonna reconnect"),Date.now()-e.previousReconnectTime<2e3?(console.log("wait 2000 msec before reconnect"),setTimeout(e.reconnect.bind(e),2e3)):e.reconnect())}})}},{key:"logIn",value:function(e){var t=this;return new Promise(function(n,o){t.pendingPromise={resolve:n,reject:o},e?console.log("login, sessId=".concat(e," (").concat(typeof e,")")):(e=function(){var e=new Uint8Array(3),t=[];return window.crypto.getRandomValues(e),e.forEach(function(e){return t.push(e.toString(16))}),t.join("")}(),t.sessId=e),t.send({type:"login",sess_id:e})})}},{key:"join",value:function(e,t){var n=this;return new Promise(function(o,s){n.pendingPromise={resolve:o,reject:s},n.send({type:"join",sess_id:e,nickname:t})})}},{key:"send",value:function(e){this.ws.send(JSON.stringify(e))}},{key:"close",value:function(){this.closedByUser=!0,this.ws&&(this.ws.close?this.ws.close():this.ws.websocket&&this.ws.websocket.close&&this.ws.websocket.close())}},{key:"onMessage",value:function(e){var t={};try{t=JSON.parse(e.data)}catch(n){return void console.warn("ws: "+n.message+". msg.data="+e.data)}switch(console.log("ws: ",t),t.type){case"login_resp":this.handleLoginResp(t);break;case"candidate":this.handleCandidate(t);break;case"offer":this.handleOffer(t);break;case"answer":this.handleAnswer(t);break;case"join_resp":this.handleJoinResp(t)}}},{key:"handleLoginResp",value:function(e){"ok"===e.status?this.pendingPromise.resolve(this.sessId):this.pendingPromise.reject(new Error(e.error)),this.pendingPromise={}}},{key:"handleJoinResp",value:function(e){"ok"===e.status?this.pendingPromise.resolve():this.pendingPromise.reject(new Error(e.error)),this.pendingPromise={}}},{key:"handleCandidate",value:function(e){console.log(Date.now()+" ws: got candidate"),this.onCandidate&&"function"===typeof this.onCandidate&&this.onCandidate(e.candidate)}},{key:"handleOffer",value:function(e){console.log(Date.now()+" ws: got offer"),e.offer?this.onOffer&&"function"===typeof this.onOffer&&this.onOffer(e.offer):console.warn(".offer is "+e.offer)}},{key:"handleAnswer",value:function(e){this.onAnswer&&"function"===typeof this.onAnswer?this.onAnswer(e.answer):console.warn("no handler")}},{key:"reconnect",value:function(){var e=this;if(!this.closedByUser){this.previousReconnectTime=Date.now(),this.ws=null;var t=1;Object(k.a)(b.a.mark(function n(){return b.a.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=1,console.log("try reconnect"),n.next=5,e.connect();case 5:return n.abrupt("break",17);case 8:return n.prev=8,n.t0=n.catch(1),console.warn(n.t0),t<10&&t++,console.log("reconnect failed, now sleeping ".concat(t," sec")),n.next=15,j(1e3*t);case 15:n.next=0;break;case 17:if(console.log("reconnected"),!e.sessId){n.next=23;break}return console.log("was logged in before, logging after reconnect"),n.next=22,e.logIn(e.sessId);case 22:console.log("login after reconnect: ok");case 23:case"end":return n.stop()}},n,null,[[1,8]])}))()}}}]),e}(),I=function(){return s.a.createElement("div",{className:"d-flex justify-content-center"},s.a.createElement("div",{className:"spinner-border",style:{width:"3rem",height:"3rem"},role:"status"},s.a.createElement("span",{className:"sr-only"},"Loading...")))},R=function(){function e(){Object(i.a)(this,e)}return Object(c.a)(e,[{key:"getDisplayMedia",value:function(){if(!this.canGetDisplayMedia())throw new Error("old browser");return navigator.mediaDevices.getDisplayMedia({audio:!1,video:{cursor:"never"}})}},{key:"getAudioStream",value:function(){var e=this;return new Promise(function(t,n){var o=e.getUserMedia();if(!o)return n("old browser");o.call(navigator,{audio:!0,video:!1},t,n)})}},{key:"isBrowserOld",value:function(){return!(this.canGetDisplayMedia()&&this.getUserMedia())}},{key:"canGetDisplayMedia",value:function(){return navigator.mediaDevices&&!!navigator.mediaDevices.getDisplayMedia}},{key:"getUserMedia",value:function(){var e=navigator;return e.getUserMedia||e.webkitGetUserMedia||e.mozGetUserMedia||e.msGetUserMedia}}]),e}(),N=v.MAIN_DIV_CLASS,M=null,D=[],P=!1,A=[],T=function(e){function t(e){var n;return Object(i.a)(this,t),(n=Object(l.a)(this,Object(d.a)(t).call(this,e))).videoRef=void 0,n.userMedia=void 0,n.stream=void 0,n.state={sessId:"",error:"",loading:!0,connectedPeersCount:0},n.videoRef=s.a.createRef(),n.userMedia=new R,n.copySessIdToClipboard=n.copySessIdToClipboard.bind(Object(u.a)(n)),n.stream=null,n.pause=n.pause.bind(Object(u.a)(n)),n.resume=n.resume.bind(Object(u.a)(n)),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this;this.userMedia.isBrowserOld()?this.setState({error:"you have an old browser, go get a newer one"}):Object(k.a)(b.a.mark(function t(){var n,o,s,a,r,i,c;return b.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,n=new x(v.WS_SRV_URL),t.next=4,x.getIceServers();case 4:return o=t.sent,s=function(t){D=[];var s=new E(t,o);s.on("candidate",function(e){P?(n.send({type:"candidate",candidate:e}),console.log(s.internalId,"candidate sent")):(console.log(s.internalId,"candidate buffered"),D.push(e))}),null!==M&&A.push(M),M=s.getRtcConnection(),s.once("connected",function(){return e.incrementPeersCount()}),s.once("disconnected",function(){e.decrementPeersCount()})},a=function(e){n.send({type:"offer",offer:e}),P=!0,D.length&&D.forEach(function(e){n.send({type:"candidate",candidate:e})})},t.next=9,n.connect();case 9:return t.next=11,n.logIn();case 11:return r=n.getSessId(),t.next=14,e.userMedia.getDisplayMedia();case 14:if(i=t.sent,!e.props.withAudio){t.next=20;break}return t.next=18,e.userMedia.getAudioStream();case 18:t.sent.getAudioTracks().forEach(function(e){i.addTrack(e)});case 20:return e.stream=i,e.videoRef.current&&(e.videoRef.current.srcObject=i),s(i),t.next=25,M.createOffer();case 25:c=t.sent,M.setLocalDescription(c),n.onAnswer=function(e){M.setRemoteDescription(new RTCSessionDescription(e)),Object(k.a)(b.a.mark(function e(){var t;return b.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("creating new peer connection..."),s(i),e.next=4,M.createOffer();case 4:t=e.sent,M.setLocalDescription(t),a(t);case 7:case"end":return e.stop()}},e)}))()},a(c),e.setState({sessId:r,loading:!1}),t.next=36;break;case 32:t.prev=32,t.t0=t.catch(0),console.error(t.t0),e.setState({error:t.t0.message});case 36:case"end":return t.stop()}},t,null,[[0,32]])}))()}},{key:"render",value:function(){return s.a.createElement("div",{className:"row"},s.a.createElement("div",{className:N},s.a.createElement("video",{ref:this.videoRef,autoPlay:!0,style:{width:"100%",display:this.state.loading?"none":"block",border:"1px solid darkgray",borderRadius:"0.5em"}}),this.getActiveElement()))}},{key:"incrementPeersCount",value:function(){this.setState({connectedPeersCount:this.state.connectedPeersCount+1})}},{key:"decrementPeersCount",value:function(){this.setState({connectedPeersCount:this.state.connectedPeersCount-1})}},{key:"copySessIdToClipboard",value:function(){navigator.clipboard&&navigator.clipboard.writeText&&navigator.clipboard.writeText(this.state.sessId)}},{key:"getActiveElement",value:function(){return this.state.error?s.a.createElement("div",{className:"alert alert-danger",role:"alert"},this.state.error):this.state.loading?s.a.createElement(I,null):s.a.createElement(s.a.Fragment,null,s.a.createElement("h5",{style:{marginTop:"2em"}},"Session ID:  ",s.a.createElement("b",null,this.state.sessId),"\xa0\xa0",s.a.createElement("button",{className:"btn btn-secondary btn-sm",onClick:this.copySessIdToClipboard},"Copy")),s.a.createElement("h5",null,"Connected peers: ",this.state.connectedPeersCount))}},{key:"pause",value:function(){function e(e){e.getSenders().forEach(function(t){e.removeTrack(t)})}M&&e(M),A.forEach(function(t){e(t)})}},{key:"resume",value:function(){var e=this;function t(e,t){t.getVideoTracks().forEach(function(t){e.addTrack(t)}),t.getAudioTracks().forEach(function(t){e.addTrack(t)})}this.stream&&(M&&(t(M,this.stream),M.addStream(this.stream)),A.forEach(function(n){t(n,e.stream)}))}}]),t}(s.a.Component),_=(n(47),function(e){function t(e){var n;return Object(i.a)(this,t),(n=Object(l.a)(this,Object(d.a)(t).call(this,e))).state={hovered:!1},n.onMouseEnter=n.onMouseEnter.bind(Object(u.a)(n)),n.onMouseLeave=n.onMouseLeave.bind(Object(u.a)(n)),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return s.a.createElement("div",{className:"CloseButton",onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,onClick:this.props.onExit},s.a.createElement("p",null,this.state.hovered?"Exit":"\xd7"))}},{key:"onMouseEnter",value:function(e){this.setState({hovered:!0})}},{key:"onMouseLeave",value:function(e){this.setState({hovered:!1})}}]),t}(s.a.Component));function U(e){switch(e){case"ENOTFOUND":return"Session with given ID not found";default:return e}}var L=function(e){function t(e){var n;return Object(i.a)(this,t),(n=Object(l.a)(this,Object(d.a)(t).call(this,e))).videoRef=void 0,n.sigServer=void 0,n.rtcConnection=null,n.state={error:""},n.videoRef=s.a.createRef(),n.exitOk=n.exitOk.bind(Object(u.a)(n)),n.sigServer=new x(v.WS_SRV_URL),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this,t=this.props.nickName;Object(k.a)(b.a.mark(function n(){var o,s;return b.a.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e.sigServer.connect();case 2:return n.next=4,x.getIceServers();case 4:return o=n.sent,s=new RTCPeerConnection({iceServers:o}),e.rtcConnection=s,s.oniceconnectionstatechange=function(t){"disconnected"===s.iceConnectionState&&(s.close(),e.sigServer.close(),e.props.onExit(new Error("peer connection was closed")))},s.ontrack=function(t){if(!e.videoRef.current)throw new Error("sth went wrong");var n=t.streams[0];e.videoRef.current.srcObject=n,e.maximizeVideoElem()},s.onicecandidate=function(n){n.candidate&&e.sigServer.send({type:"candidate",candidate:n.candidate,nickname:t})},e.sigServer.onOffer=function(n){try{s.setRemoteDescription(new RTCSessionDescription(n)),s.createAnswer().then(function(n){s.setLocalDescription(n),e.sigServer.send({type:"answer",answer:n,nickname:t})},function(e){console.error(e)})}catch(o){console.error(o)}},e.sigServer.onCandidate=function(e){try{s.addIceCandidate(new RTCIceCandidate(e))}catch(t){console.warn(t.message),console.log("candidate:",e)}},n.prev=12,n.next=15,e.sigServer.join(e.props.sessId,t);case 15:n.next=21;break;case 17:n.prev=17,n.t0=n.catch(12),console.warn(n.t0),e.props.onExit(new Error(U(n.t0.message)));case 21:case"end":return n.stop()}},n,null,[[12,17]])}))()}},{key:"render",value:function(){return s.a.createElement("div",{className:"row"},s.a.createElement("div",{className:"col-xs-12"},s.a.createElement("video",{ref:this.videoRef,autoPlay:!0,style:{width:"100%"}}),s.a.createElement(_,{onExit:this.exitOk})))}},{key:"maximizeVideoElem",value:function(){this.videoRef.current&&(this.videoRef.current.style.position="absolute",this.videoRef.current.style.top="0px",this.videoRef.current.style.left="0px")}},{key:"exitOk",value:function(){this.rtcConnection&&this.rtcConnection.close(),this.sigServer.close(),this.props.onExit()}}]),t}(s.a.Component),V=function(e){function t(e,n){var o;return Object(i.a)(this,t),(o=Object(l.a)(this,Object(d.a)(t).call(this,e,n))).state={error:""},o.onUserDecision=o.onUserDecision.bind(Object(u.a)(o)),o.onExit=o.onExit.bind(Object(u.a)(o)),o}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return s.a.createElement("div",{className:"container-fluid"},s.a.createElement("div",{className:"row"},s.a.createElement("h1",{className:"col-sm-12 App-header2",style:{textAlign:"center"}},"BeamViewer")),this.getActiveComponent())}},{key:"onExit",value:function(e){e?this.setState({appMode:void 0,error:e.message}):this.setState({appMode:void 0})}},{key:"onUserDecision",value:function(e){this.setState({appMode:e})}},{key:"getActiveComponent",value:function(){if(this.state.appMode){if("pub"===this.state.appMode.mode)return s.a.createElement(T,{withAudio:this.state.appMode.withAudio});if("sub"===this.state.appMode.mode)return s.a.createElement(L,{nickName:this.state.appMode.nickName,sessId:this.state.appMode.sessionId,onExit:this.onExit});throw new Error}return s.a.createElement(g,{onDecision:this.onUserDecision,error:this.state.error})}}]),t}(s.a.Component);n(48),Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));"http:"===window.location.protocol&&"localhost"!==window.location.hostname&&(console.log("redirect to https"),window.location.replace(window.location.href.replace("http:","https:"))),r.a.render(s.a.createElement(V,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})}},[[22,1,2]]]);
//# sourceMappingURL=main.76297b4f.chunk.js.map